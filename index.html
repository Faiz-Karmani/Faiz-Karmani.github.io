<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal Jakarta - Koordinasi Satu Peta</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body, html { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #header { height: 60px; background: #1a237e; color: white; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; }
        #main-container { height: calc(100% - 60px); display: flex; }
        #sidebar-nav { width: 80px; background: #283593; display: flex; flex-direction: column; align-items: center; padding-top: 20px; }
        .nav-btn { width: 50px; height: 50px; margin-bottom: 20px; border-radius: 10px; border: none; background: rgba(255,255,255,0.1); color: white; cursor: pointer; transition: 0.3s; }
        .nav-btn:hover, .nav-btn.active { background: #ffca28; color: #1a237e; }
        .nav-label { font-size: 10px; margin-top: 5px; text-align: center; color: white; }
        #content-area { flex: 1; position: relative; background: #f5f5f5; }
        .view-section { display: none; height: 100%; width: 100%; }
        .view-section.active { display: block; }
        #map { width: 100%; height: 100%; background-color: #ffffff !important; }
        
        /* UI Components */
        .catalog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px; overflow-y: auto; height: 100%; }
        .meta-card { background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 15px; border-left: 5px solid #1a237e; }
        .meta-badge { font-size: 11px; padding: 3px 8px; border-radius: 4px; color: white; margin-right: 5px;}
        .analysis-container { display: flex; height: 100%; }
        .analysis-sidebar { width: 350px; background: white; padding: 20px; border-right: 1px solid #ddd; overflow-y: auto; }
        .analysis-map { flex: 1; background: #eee; position: relative; }
        .result-box { background: #e8f5e9; border: 1px solid #c8e6c9; padding: 15px; border-radius: 5px; margin-top: 20px; }

        /* Login & Popup */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26, 35, 126, 0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 10px; width: 350px; text-align: center; }
        .leaflet-popup-content { width: auto !important; min-width: 350px; max-width: 600px; }
        .leaflet-popup-content table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .leaflet-popup-content td, .leaflet-popup-content th { padding: 5px 8px; border-bottom: 1px solid #ddd; }
        .leaflet-popup-content tr:nth-child(even) { background-color: #f9f9f9; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h4>üîê Masuk Geoportal</h4>
            <p class="text-muted small">Koordinasi Satu Peta Jakarta</p>
            <div class="mb-3 text-start">
                <label class="form-label small fw-bold">Pilih Instansi:</label>
                <select id="user-role" class="form-select">
                    <option value="BIG">Admin BIG</option>
                    <option value="BNPB">Admin BNPB</option>
                    <option value="BPN">Admin ATR/BPN</option>
                    <option value="PEMDA">Admin PEMDA</option>
                </select>
            </div>
            <div class="mb-4 text-start">
                <label class="form-label small fw-bold">Password:</label>
                <input type="password" id="user-pass" class="form-control" placeholder="Masukkan password...">
            </div>
            <button onclick="login()" class="btn btn-primary w-100 fw-bold">MASUK</button>
            <p id="login-error" class="text-danger small mt-3 fw-bold" style="display:none;">Password Salah!</p>
        </div>
    </div>

    <div id="header">
        <div class="d-flex align-items-center">
            <i class="fa-solid fa-map-location-dot fa-xl me-3"></i>
            <div>
                <h6 class="m-0 fw-bold">GEOPORTAL JAKARTA</h6>
                <small style="font-size: 11px;">Koordinasi Satu Peta: BIG - BNPB - BPN - PEMDA</small>
            </div>
        </div>
        <div class="d-flex align-items-center">
            <span id="user-display" class="badge bg-warning text-dark me-3">Guest</span>
            <button onclick="logout()" class="btn btn-sm btn-outline-light"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </div>

    <div id="main-container">
        <div id="sidebar-nav">
            <button class="nav-btn active" onclick="switchView('map-view')"><i class="fa-solid fa-layer-group fa-lg"></i></button>
            <div class="nav-label">Peta Utama</div>
            <button class="nav-btn" onclick="switchView('metadata-view')"><i class="fa-solid fa-book-open fa-lg"></i></button>
            <div class="nav-label">Katalog</div>
            <button class="nav-btn" onclick="switchView('analysis-view')"><i class="fa-solid fa-calculator fa-lg"></i></button>
            <div class="nav-label">Analisis</div>
        </div>

        <div id="content-area">
            <div id="map-view" class="view-section active">
                <div id="map"></div>
            </div>

            <div id="metadata-view" class="view-section">
                <div class="d-flex h-100">
                    <div class="catalog-grid" id="catalog-list" style="width: 50%;"></div>
                    <div id="bbox-map" style="width: 50%; border-left: 2px solid #ddd;"></div>
                </div>
            </div>

            <div id="analysis-view" class="view-section">
                <div class="analysis-container">
                    <div class="analysis-sidebar">
                        <h5 class="fw-bold border-bottom pb-2 mb-3">üõ†Ô∏è Pusat Analisis</h5>
                        <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                            <li class="nav-item"><button class="nav-link active" id="vector-tab" data-bs-toggle="tab" data-bs-target="#vector-pane">Vektor (Kerugian)</button></li>
                            <li class="nav-item"><button class="nav-link" id="raster-tab" data-bs-toggle="tab" data-bs-target="#raster-pane">Raster (Area)</button></li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="vector-pane">
                                <p class="small text-muted">Hitung persil tanah terdampak banjir.</p>
                                <button onclick="runVectorAnalysis()" class="btn btn-primary w-100 btn-sm">üöÄ Hitung Dampak Kerugian</button>
                                <div id="vector-result" class="result-box d-none">
                                    <div class="d-flex justify-content-between mb-1"><span>Persil Terdampak:</span> <b class="text-danger" id="res-count">0</b></div>
                                    <div class="d-flex justify-content-between mb-1"><span>Luas Terendam:</span> <b class="text-danger" id="res-area">0 Ha</b></div>
                                    <div class="d-flex justify-content-between border-top pt-2"><span>Est. Kerugian:</span> <b class="text-danger" id="res-loss">Rp 0</b></div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="raster-pane">
                                <p class="small text-muted">Kalkulator Raster: Mencari area "Aman".</p>
                                <button onclick="runRasterAnalysis()" class="btn btn-success w-100 btn-sm">üßÆ Cari Zona Aman</button>
                                <div id="raster-result" class="result-box d-none">
                                    <span class="text-success fw-bold">Analisis Selesai!</span>
                                    <p class="small m-0">Menampilkan layer hasil <b>'Zona_Aman_DKI'</b>.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="analysis-map" class="analysis-map"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script> 
    
    <script>
        // --- KONFIGURASI ---
        const GS_URL = "https://geoserver-kel4ids-wps-production.up.railway.app/geoserver"; 
        
        // --- DATABASE LAYER (Hanya Vektor untuk Main Map) ---
        const layersDB = [
            { id: 'batas_kecamatan', name: 'Batas Administrasi Kecamatan', instansi: 'BIG', type: 'Vektor', layerName: 'BIG:Batas_Provinsi_DKI_fix' },
            { id: 'jalan', name: 'Jaringan Jalan', instansi: 'BIG', type: 'Vektor', layerName: 'BIG:Jalan_Provinsi_DKI' },
            { id: 'banjir_vec', name: 'Kejadian Banjir (Vektor)', instansi: 'BNPB', type: 'Vektor', layerName: 'BNPB:Area_Terjadi_Banjir_Provinsi_DKI' },
            { id: 'rawan_vec', name: 'Rawan Banjir (Vektor)', instansi: 'BNPB', type: 'Vektor', layerName: 'BNPB:Rawan_Banjir_3kelas_Provinsi_DKI' },
            { id: 'persil', name: 'Persil Tanah', instansi: 'BPN', type: 'Vektor', layerName: 'BPN:Persil_Hak_DKI' },
            { id: 'faskes', name: 'Layanan Kesehatan', instansi: 'Pemda', type: 'Vektor', layerName: 'Pemda:Kesehatan_Provinsi_DKI' },
            { id: 'kantor', name: 'Kantor Administrasi', instansi: 'Pemda', type: 'Vektor', layerName: 'Pemda:Pemerintahan_Provinsi_DKI' }
        ];

        let map, analysisMap, bboxMap;
        let activeLayers = {}; 

        window.onload = function() { initMaps(); generateMetadataCatalog(); };

        function initMaps() {
            // 1. BASEMAPS
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' });
            const whiteLayer = L.layerGroup(); 
            const baseMaps = { "OpenStreetMap": osmLayer, "Tanpa Peta (Putih)": whiteLayer };

            // 2. INIT MAIN MAP
            map = L.map('map', { center: [-6.1754, 106.8272], zoom: 11, layers: [osmLayer] });

            // 3. LAYER DARI GEOSERVER (WMS)
            layersDB.forEach(l => {
                const wmsLayer = L.tileLayer.wms(`${GS_URL}/wms`, {
                    layers: l.layerName, format: 'image/png', transparent: true, attribution: l.instansi, tiled: true
                });
                
                map.on('click', function(e) {
                    if (map.hasLayer(wmsLayer)) getFeatureInfo(e, l.layerName);
                });
                
                activeLayers[l.id] = wmsLayer;
            });

            // 4. LAYER RASTER GITHUB
            const githubDemnas = L.tileLayer('https://faiz-karmani.github.io/petarasterids/{z}/{x}/{y}.png', { tms: false, attribution: 'BIG (GitHub)', minZoom: 10, maxZoom: 15, zIndex: 500 });
            const githubRawan = L.tileLayer('https://faiz-karmani.github.io/petarasterids/rawan/{z}/{x}/{y}.png', { tms: false, attribution: 'BNPB (GitHub)', minZoom: 10, maxZoom: 15, zIndex: 500 });
            const githubKejadian = L.tileLayer('https://faiz-karmani.github.io/petarasterids/kejadian/{z}/{x}/{y}.png', { tms: false, attribution: 'BNPB (GitHub)', minZoom: 10, maxZoom: 15, zIndex: 500 });

            // 5. MENU LAYER
            let overlayMaps = {};
            overlayMaps["<b style='color:#1976d2'>[BIG]</b> DEMNAS (Elevasi)"] = githubDemnas;
            overlayMaps["<b style='color:#1976d2'>[BIG]</b> Batas Kecamatan"] = activeLayers['batas_kecamatan'];
            overlayMaps["<b style='color:#1976d2'>[BIG]</b> Jalan"] = activeLayers['jalan'];
            overlayMaps["<b style='color:#d32f2f'>[BNPB]</b> Rawan Banjir (Raster)"] = githubRawan;
            overlayMaps["<b style='color:#d32f2f'>[BNPB]</b> Kejadian Banjir (Raster)"] = githubKejadian;
            overlayMaps["<b style='color:#d32f2f'>[BNPB]</b> Kejadian Banjir (Vektor)"] = activeLayers['banjir_vec'];
            overlayMaps["<b style='color:#d32f2f'>[BNPB]</b> Rawan Banjir (Vektor)"] = activeLayers['rawan_vec'];
            overlayMaps["<b style='color:#fbc02d'>[BPN]</b> Persil Tanah"] = activeLayers['persil'];
            overlayMaps["<b style='color:#388e3c'>[Pemda]</b> Faskes"] = activeLayers['faskes'];
            overlayMaps["<b style='color:#388e3c'>[Pemda]</b> Kantor Pemda"] = activeLayers['kantor'];

            githubDemnas.addTo(map);
            L.control.layers(baseMaps, overlayMaps, {collapsed: false}).addTo(map);

            // 6. SETUP ANALYSIS MAP
            setTimeout(() => {
                bboxMap = L.map('bbox-map', {zoomControl: false, layers: [L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')]}).setView([-6.1754, 106.8272], 10);
                analysisMap = L.map('analysis-map', {layers: [L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')]}).setView([-6.1754, 106.8272], 11);
            }, 1000);
        }

        // --- KLIK INFO ---
        function getFeatureInfo(e, layerName) {
            const url = `${GS_URL}/wms?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo&LAYERS=${layerName}&QUERY_LAYERS=${layerName}&STYLES=&BBOX=${map.getBounds().toBBoxString()}&FEATURE_COUNT=1&HEIGHT=${map.getSize().y}&WIDTH=${map.getSize().x}&FORMAT=image/png&INFO_FORMAT=application/json&SRS=EPSG:4326&X=${Math.round(e.containerPoint.x)}&Y=${Math.round(e.containerPoint.y)}`;
            fetch(url).then(r => r.json()).then(data => {
                if (data.features && data.features.length > 0) {
                    let content = `<div style="max-height:200px; overflow:auto;"><h6>Info Atribut</h6><table class="table table-sm table-striped" style="font-size:10px;">`;
                    for (let key in data.features[0].properties) content += `<tr><td>${key}</td><td>${data.features[0].properties[key]}</td></tr>`;
                    content += `</table></div>`;
                    L.popup({ maxWidth: 600, minWidth: 400 }).setLatLng(e.latlng).setContent(content).openOn(map);
                }
            });
        }

        // --- KATALOG ---
        function generateMetadataCatalog() {
            const container = document.getElementById('catalog-list');
            let html = '';
            layersDB.forEach(l => {
                html += `<div class="meta-card"><span class="meta-badge" style="background:${getColor(l.instansi)}">${l.instansi}</span><h5>${l.name}</h5><p class="small text-muted">Data Geospasial ${l.instansi}</p><button class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-download"></i> Download</button></div>`;
            });
            container.innerHTML = html;
        }

        // --- üöÄ ANALISIS VEKTOR (SIMULASI) ---
        function runVectorAnalysis() {
            const btn = document.querySelector('button[onclick="runVectorAnalysis()"]');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Menghitung...';
            
            // Tampilkan layer di peta analisis
            activeLayers['banjir_vec'].addTo(analysisMap); 
            activeLayers['persil'].addTo(analysisMap);
            
            setTimeout(() => {
                document.getElementById('vector-result').classList.remove('d-none');
                document.getElementById('res-count').innerText = "1245 Bidang";
                document.getElementById('res-area').innerText = "450.5 Ha";
                document.getElementById('res-loss').innerText = "Rp 154.200.000.000";
                btn.innerHTML = 'üöÄ Hitung Dampak Kerugian';
                alert("Analisis Selesai!");
            }, 2000);
        }

        // --- üßÆ ANALISIS RASTER (LOAD HASIL JADI DARI GEOSERVER) ---
        function runRasterAnalysis() {
            const btn = document.querySelector('button[onclick="runRasterAnalysis()"]');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Memproses Overlay...';

            // 1. Bersihkan peta analisis (buang layer lama)
            analysisMap.eachLayer(l => { if(l instanceof L.TileLayer.WMS) analysisMap.removeLayer(l); });

            // 2. Load Layer "RAHASIA" (Hasil Jadi) dari GeoServer
            setTimeout(() => {
                document.getElementById('raster-result').classList.remove('d-none');
                
                // --- üî• GANTI INI DENGAN NAMA LAYER ZONA AMAN DI GEOSERVER ANDA ---
                const namaLayerZonaAman = "BNPB:Zona_Aman_DKI_Fix"; // <-- GANTI INI
                
                const resultLayer = L.tileLayer.wms(`${GS_URL}/wms`, {
                    layers: namaLayerZonaAman,
                    format: 'image/png',
                    transparent: true,
                    attribution: 'Hasil Analisis',
                    tiled: true
                    // styles: 'hijau' (Opsional: jika mau paksa style tertentu)
                });
                
                resultLayer.addTo(analysisMap);
                resultLayer.bringToFront();

                btn.innerHTML = 'üßÆ Cari Zona Aman';
                alert("Analisis Selesai! Menampilkan Zona Aman.");
            }, 2000);
        }

        // --- AUTH & UTIL ---
        function login() {
            const creds = { 'BIG':'big123', 'BNPB':'bnpb123', 'BPN':'bpn123', 'PEMDA':'pemda123' };
            const r = document.getElementById('user-role').value;
            if (creds[r] === document.getElementById('user-pass').value) { document.getElementById('login-overlay').style.display = 'none'; document.getElementById('user-display').innerText = r; }
            else { document.getElementById('login-error').style.display = 'block'; }
        }
        function logout() { location.reload(); }
        function switchView(id) {
            document.querySelectorAll('.view-section, .nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id==='map-view') document.querySelectorAll('.nav-btn')[0].classList.add('active');
            if(id==='metadata-view') document.querySelectorAll('.nav-btn')[1].classList.add('active');
            if(id==='analysis-view') document.querySelectorAll('.nav-btn')[2].classList.add('active');
            setTimeout(() => { map.invalidateSize(); analysisMap.invalidateSize(); bboxMap.invalidateSize(); }, 100);
        }
        function getColor(i) {
            if(i==='BIG')return'#1976d2'; if(i==='BNPB')return'#d32f2f'; if(i==='BPN')return'#fbc02d'; if(i==='PEMDA')return'#388e3c'; return'grey';
        }
    </script>
</body>
</html>
