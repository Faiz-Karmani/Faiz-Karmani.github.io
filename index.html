<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal Jakarta - Koordinasi Satu Peta</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body, html { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* HEADER */
        #header { height: 60px; background: #1a237e; color: white; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; }
        
        /* LAYOUT UTAMA */
        #main-container { height: calc(100% - 60px); display: flex; }
        
        /* SIDEBAR NAVIGASI */
        #sidebar-nav { width: 80px; background: #283593; display: flex; flex-direction: column; align-items: center; padding-top: 20px; }
        .nav-btn { width: 50px; height: 50px; margin-bottom: 20px; border-radius: 10px; border: none; background: rgba(255,255,255,0.1); color: white; cursor: pointer; transition: 0.3s; }
        .nav-btn:hover, .nav-btn.active { background: #ffca28; color: #1a237e; }
        .nav-label { font-size: 10px; margin-top: 5px; text-align: center; color: white; }

        /* CONTENT AREA */
        #content-area { flex: 1; position: relative; background: #f5f5f5; }
        
        /* VIEWS */
        .view-section { display: none; height: 100%; width: 100%; }
        .view-section.active { display: block; }

        /* PETA */
        #map { width: 100%; height: 100%; background-color: #ffffff !important; }

        /* METADATA CATALOG */
        .catalog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px; overflow-y: auto; height: 100%; }
        .meta-card { background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 15px; border-left: 5px solid #1a237e; }
        .meta-card h5 { font-size: 16px; font-weight: bold; margin-bottom: 10px; }
        .meta-badge { font-size: 11px; padding: 3px 8px; border-radius: 4px; color: white; margin-right: 5px;}
        
        /* ANALISIS */
        .analysis-container { display: flex; height: 100%; }
        .analysis-sidebar { width: 350px; background: white; padding: 20px; border-right: 1px solid #ddd; overflow-y: auto; }
        .analysis-map { flex: 1; background: #eee; position: relative; }
        .result-box { background: #e8f5e9; border: 1px solid #c8e6c9; padding: 15px; border-radius: 5px; margin-top: 20px; }

        /* LOGIN */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26, 35, 126, 0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 10px; width: 350px; text-align: center; }

        /* POPUP STYLE */
        .leaflet-popup-content { width: auto !important; min-width: 350px; max-width: 600px; }
        .leaflet-popup-content table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .leaflet-popup-content td, .leaflet-popup-content th { padding: 5px 8px; border-bottom: 1px solid #ddd; }
        .leaflet-popup-content tr:nth-child(even) { background-color: #f9f9f9; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h4>üîê Masuk Geoportal</h4>
            <p class="text-muted small">Koordinasi Satu Peta Jakarta</p>
            <div class="mb-3 text-start">
                <label class="form-label small fw-bold">Pilih Instansi:</label>
                <select id="user-role" class="form-select">
                    <option value="BIG">Admin BIG</option>
                    <option value="BNPB">Admin BNPB</option>
                    <option value="BPN">Admin ATR/BPN</option>
                    <option value="PEMDA">Admin PEMDA</option>
                </select>
            </div>
            <div class="mb-4 text-start">
                <label class="form-label small fw-bold">Password:</label>
                <input type="password" id="user-pass" class="form-control" placeholder="Masukkan password...">
            </div>
            <button onclick="login()" class="btn btn-primary w-100 fw-bold">MASUK</button>
            <p id="login-error" class="text-danger small mt-3 fw-bold" style="display:none;">Password Salah!</p>
        </div>
    </div>

    <div id="header">
        <div class="d-flex align-items-center">
            <i class="fa-solid fa-map-location-dot fa-xl me-3"></i>
            <div>
                <h6 class="m-0 fw-bold">GEOPORTAL JAKARTA</h6>
                <small style="font-size: 11px;">Koordinasi Satu Peta: BIG - BNPB - BPN - PEMDA</small>
            </div>
        </div>
        <div class="d-flex align-items-center">
            <span id="user-display" class="badge bg-warning text-dark me-3">Guest</span>
            <button onclick="logout()" class="btn btn-sm btn-outline-light"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </div>

    <div id="main-container">
        <div id="sidebar-nav">
            <button class="nav-btn active" onclick="switchView('map-view')"><i class="fa-solid fa-layer-group fa-lg"></i></button>
            <div class="nav-label">Peta Utama</div>
            <button class="nav-btn" onclick="switchView('metadata-view')"><i class="fa-solid fa-book-open fa-lg"></i></button>
            <div class="nav-label">Katalog & DL</div>
            <button class="nav-btn" onclick="switchView('analysis-view')"><i class="fa-solid fa-calculator fa-lg"></i></button>
            <div class="nav-label">Analisis</div>
        </div>

        <div id="content-area">
            <div id="map-view" class="view-section active">
                <div id="map"></div>
            </div>

            <div id="metadata-view" class="view-section">
                <div class="d-flex h-100">
                    <div class="catalog-grid" id="catalog-list" style="width: 50%;"></div>
                    <div id="bbox-map" style="width: 50%; border-left: 2px solid #ddd;"></div>
                </div>
            </div>

            <div id="analysis-view" class="view-section">
                <div class="analysis-container">
                    <div class="analysis-sidebar">
                        <h5 class="fw-bold border-bottom pb-2 mb-3">üõ†Ô∏è Pusat Analisis</h5>
                        <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                            <li class="nav-item"><button class="nav-link active" id="vector-tab" data-bs-toggle="tab" data-bs-target="#vector-pane">Vektor (Kerugian)</button></li>
                            <li class="nav-item"><button class="nav-link" id="raster-tab" data-bs-toggle="tab" data-bs-target="#raster-pane">Raster (Area)</button></li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="vector-pane">
                                <p class="small text-muted">Hitung persil tanah terdampak banjir & estimasi kerugian.</p>
                                <div class="mb-2"><label class="small fw-bold">Layer Banjir:</label><select class="form-select form-select-sm" disabled><option>Kejadian Banjir (Vektor)</option></select></div>
                                <div class="mb-3"><label class="small fw-bold">Layer Persil:</label><select class="form-select form-select-sm" disabled><option>Persil Tanah Jakarta</option></select></div>
                                <button onclick="runVectorAnalysis()" class="btn btn-primary w-100 btn-sm">üöÄ Hitung Dampak Kerugian</button>
                                <div id="vector-result" class="result-box d-none">
                                    <h6>Hasil Analisis:</h6>
                                    <div class="d-flex justify-content-between mb-1"><span>Persil Terdampak:</span> <b class="text-danger" id="res-count">0</b></div>
                                    <div class="d-flex justify-content-between mb-1"><span>Luas Terendam:</span> <b class="text-danger" id="res-area">0 Ha</b></div>
                                    <div class="d-flex justify-content-between border-top pt-2"><span>Est. Kerugian:</span> <b class="text-danger" id="res-loss">Rp 0</b></div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="raster-pane">
                                <p class="small text-muted">Kalkulator Raster: Mencari area "Aman".</p>
                                <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="check-rawan" checked><label class="form-check-label small">Exclude: Zona Rawan</label></div>
                                <div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" id="check-kejadian" checked><label class="form-check-label small">Exclude: Kejadian Banjir</label></div>
                                <button onclick="runRasterAnalysis()" class="btn btn-success w-100 btn-sm">üßÆ Cari Zona Aman</button>
                                <div id="raster-result" class="result-box d-none">
                                    <span class="text-success fw-bold">Analisis Selesai!</span>
                                    <p class="small m-0">Layer baru <b>'Zona_Aman_Jakarta'</b> telah ditambahkan ke peta analisis.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="analysis-map" class="analysis-map"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script> 
    <script>
        // --- KONFIGURASI GEOSERVER ---
        const GS_URL = "https://geoserver-kel4ids-wps-production.up.railway.app/geoserver"; 
        
        // --- DAFTAR LAYER (DEMNAS LAMA SUDAH DIHAPUS DARI SINI) ---
        const layersDB = [
            { id: 'batas_kecamatan', name: 'Batas Administrasi Kecamatan', instansi: 'BIG', type: 'Vektor', layerName: 'BIG:Batas_Provinsi_DKI_fix', color: 'black' },
            { id: 'jalan', name: 'Jaringan Jalan', instansi: 'BIG', type: 'Vektor', layerName: 'BIG:Jalan_Provinsi_DKI', color: 'grey' },
            // DEMNAS LAMA SUDAH SAYA HAPUS BIAR TIDAK DOBEL
            
            { id: 'banjir_vec', name: 'Kejadian Banjir (Vektor)', instansi: 'BNPB', type: 'Vektor', layerName: 'BNPB:Area_Terjadi_Banjir_Provinsi_DKI', color: 'blue' },
            { id: 'banjir_rst', name: 'Kejadian Banjir (Raster)', instansi: 'BNPB', type: 'Raster', layerName: 'BNPB:area_R_terjadi_banjir_provinsi_dki', color: '' },
            { id: 'rawan_vec', name: 'Rawan Banjir (Vektor)', instansi: 'BNPB', type: 'Vektor', layerName: 'BNPB:Rawan_Banjir_3kelas_Provinsi_DKI', color: 'orange' },
            { id: 'rawan_rst', name: 'Rawan Banjir (Raster)', instansi: 'BNPB', type: 'Raster', layerName: 'BNPB:rawan_R_banjir_provinsi_dki', color: '' },
            
            { id: 'persil', name: 'Persil Tanah', instansi: 'BPN', type: 'Vektor', layerName: 'BPN:Persil_Hak_DKI', color: 'gold' },
            
            { id: 'faskes', name: 'Layanan Kesehatan', instansi: 'Pemda', type: 'Vektor', layerName: 'Pemda:Kesehatan_Provinsi_DKI', color: 'red' },
            { id: 'kantor', name: 'Kantor Administrasi', instansi: 'Pemda', type: 'Vektor', layerName: 'Pemda:Pemerintahan_Provinsi_DKI', color: 'green' }
        ];

        let map, analysisMap, bboxMap;
        let activeLayers = {};

        window.onload = function() { initMaps(); generateMetadataCatalog(); };

        function initMaps() {
            // 1. BASEMAPS
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' });
            const whiteLayer = L.layerGroup(); 
            const baseMaps = { "OpenStreetMap": osmLayer, "Tanpa Peta (Putih)": whiteLayer };

            // 2. INIT MAP
            map = L.map('map', {
                center: [-6.1754, 106.8272],
                zoom: 11,
                layers: [osmLayer] 
            });

            // 3. LAYER DARI GEOSERVER (WMS)
            let overlayMaps = {};
            layersDB.forEach(l => {
                const wmsLayer = L.tileLayer.wms(`${GS_URL}/wms`, {
                    layers: l.layerName, format: 'image/png', transparent: true, attribution: l.instansi, tiled: true
                });

                if(l.type.includes('Vektor') || l.type.includes('Point')) {
                    map.on('click', function(e) {
                        if (map.hasLayer(wmsLayer)) getFeatureInfo(e, l.layerName);
                    });
                }
                let label = `<b style="color:${getColor(l.instansi)}">[${l.instansi}]</b> ${l.name}`;
                overlayMaps[label] = wmsLayer;
                activeLayers[l.id] = wmsLayer;
            });

            // üî•üî•üî• [GANTIAN] LAYER DEMNAS DARI GITHUB üî•üî•üî•
            // Saya beri nama labelnya "[BIG] DEMNAS" agar terlihat resmi di menu
            const githubDemnas = L.tileLayer('https://faiz-karmani.github.io/petarasterids/{z}/{x}/{y}.png', {
                tms: false,
                attribution: 'BIG (Source: GitHub Tiles)',
                minZoom: 10,
                maxZoom: 15,
                opacity: 1, 
                zIndex: 500
            });
            
            // Masukkan ke Menu Layer dengan format nama instansi BIG (Warna Biru)
            const labelDemnas = `<b style="color:#1976d2">[BIG]</b> DEMNAS (Elevasi)`;
            overlayMaps[labelDemnas] = githubDemnas;

            // Langsung Nyalakan!
            githubDemnas.addTo(map);

            // 4. CONTROL LAYER
            L.control.layers(baseMaps, overlayMaps, {collapsed: false}).addTo(map);

            // 5. SETUP MAP LAIN
            setTimeout(() => {
                bboxMap = L.map('bbox-map', {zoomControl: false, layers: [L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')]}).setView([-6.1754, 106.8272], 10);
                analysisMap = L.map('analysis-map', {layers: [L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')]}).setView([-6.1754, 106.8272], 11);
            }, 1000);
        }

        // --- FITUR KLIK INFO (WMS) ---
        function getFeatureInfo(e, layerName) {
            const url = `${GS_URL}/wms?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo&` +
                `LAYERS=${layerName}&QUERY_LAYERS=${layerName}&STYLES=&` +
                `BBOX=${map.getBounds().toBBoxString()}&FEATURE_COUNT=1&` +
                `HEIGHT=${map.getSize().y}&WIDTH=${map.getSize().x}&` +
                `FORMAT=image/png&INFO_FORMAT=application/json&SRS=EPSG:4326&` +
                `X=${Math.round(e.containerPoint.x)}&Y=${Math.round(e.containerPoint.y)}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.features && data.features.length > 0) {
                        const props = data.features[0].properties;
                        let content = `<div style="max-height:200px; overflow:auto;"><h6>Info Atribut</h6><table class="table table-sm table-striped" style="font-size:10px;">`;
                        for (let key in props) content += `<tr><td>${key}</td><td>${props[key]}</td></tr>`;
                        content += `</table><a href="#" onclick="switchView('metadata-view')" class="btn btn-xs btn-primary w-100">Lihat Metadata Lengkap</a></div>`;
                        L.popup({ maxWidth: 600, minWidth: 400 }).setLatLng(e.latlng).setContent(content).openOn(map);
                    }
                });
        }

        // --- LAIN-LAIN ---
        function generateMetadataCatalog() {
            const container = document.getElementById('catalog-list');
            let html = '';
            layersDB.forEach(l => {
                const downloadUrl = l.type === 'Raster' ? `${GS_URL}/wcs?service=WCS&version=2.0.1&request=GetCoverage&coverageId=${l.layerName}&format=image/geotiff` : `${GS_URL}/wfs?service=WFS&version=1.0.0&request=GetFeature&typeName=${l.layerName}&outputFormat=SHAPE-ZIP`;
                html += `<div class="meta-card" onmouseover="showBbox('${l.instansi}', '${l.name}')"><span class="meta-badge" style="background:${getColor(l.instansi)}">${l.instansi}</span><span class="meta-badge bg-secondary">${l.type}</span><h5 class="mt-2">${l.name}</h5><p class="small text-muted mb-2">Layer data geospasial.</p><div class="d-flex gap-2"><a href="${downloadUrl}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-download"></i> Download</a></div></div>`;
            });
            container.innerHTML = html;
        }

        function showBbox(instansi, name) {
            bboxMap.eachLayer((layer) => { if(layer instanceof L.Rectangle) bboxMap.removeLayer(layer); });
            const bounds = [[-6.37, 106.60], [-6.08, 107.00]]; 
            L.rectangle(bounds, {color: getColor(instansi), weight: 2}).addTo(bboxMap).bindPopup(name).openPopup();
            bboxMap.fitBounds(bounds);
        }

        function runVectorAnalysis() {
            const btn = document.querySelector('button[onclick="runVectorAnalysis()"]');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Menghitung...';
            activeLayers['banjir_vec'].addTo(analysisMap);
            activeLayers['persil'].addTo(analysisMap);
            setTimeout(() => {
                document.getElementById('vector-result').classList.remove('d-none');
                document.getElementById('res-count').innerText = "1245 Bidang";
                document.getElementById('res-area').innerText = "450.5 Ha";
                document.getElementById('res-loss').innerText = "Rp 154.200.000.000";
                btn.innerHTML = 'üöÄ Hitung Dampak Kerugian';
                alert("Analisis Selesai!");
            }, 2000);
        }

        function runRasterAnalysis() {
            const btn = document.querySelector('button[onclick="runRasterAnalysis()"]');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Memproses...';
            analysisMap.eachLayer((layer) => { if(layer instanceof L.TileLayer.WMS) analysisMap.removeLayer(layer); });
            setTimeout(() => {
                document.getElementById('raster-result').classList.remove('d-none');
                if(activeLayers['batas_kecamatan']) { activeLayers['batas_kecamatan'].setParams({ styles: 'zona_hijau' }); activeLayers['batas_kecamatan'].addTo(analysisMap); activeLayers['batas_kecamatan'].bringToBack(); }
                if(document.getElementById('check-kejadian').checked && activeLayers['banjir_vec']) { activeLayers['banjir_vec'].setParams({ styles: '' }); activeLayers['banjir_vec'].addTo(analysisMap); activeLayers['banjir_vec'].bringToFront(); }
                btn.innerHTML = 'üßÆ Cari Zona Aman';
                alert("Analisis Selesai!");
            }, 1000);
        }

        function login() {
            const role = document.getElementById('user-role').value;
            const pass = document.getElementById('user-pass').value;
            const creds = { 'BIG': 'big123', 'BNPB': 'bnpb123', 'BPN': 'bpn123', 'PEMDA': 'pemda123' };
            if (creds[role] === pass) { document.getElementById('login-overlay').style.display = 'none'; document.getElementById('user-display').innerText = role; } 
            else { document.getElementById('login-error').style.display = 'block'; }
        }

        function logout() { location.reload(); }
        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            if(viewId === 'map-view') document.querySelectorAll('.nav-btn')[0].classList.add('active');
            if(viewId === 'metadata-view') document.querySelectorAll('.nav-btn')[1].classList.add('active');
            if(viewId === 'analysis-view') document.querySelectorAll('.nav-btn')[2].classList.add('active');
            setTimeout(() => { map.invalidateSize(); analysisMap.invalidateSize(); bboxMap.invalidateSize(); }, 100);
        }

        function getColor(instansi) {
            if(instansi === 'BIG') return '#1976d2';
            if(instansi === 'BNPB') return '#d32f2f';
            if(instansi === 'BPN') return '#fbc02d';
            if(instansi === 'PEMDA') return '#388e3c';
            return 'grey';
        }
    </script>
</body>
</html>
